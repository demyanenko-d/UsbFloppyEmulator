# 💾 USB Floppy Disk Drive Emulator

[![Platform](https://img.shields.io/badge/Platform-Raspberry%20Pi%20Pico-red)](https://www.raspberrypi.com/products/raspberry-pi-pico/)
[![RTOS](https://img.shields.io/badge/RTOS-FreeRTOS%2011.1.0-blue)](https://www.freertos.org/)
[![License](https://img.shields.io/badge/License-MIT-green)](LICENSE)

Современный USB-эмулятор флоппи-дисковода на базе Raspberry Pi Pico/Pico 2 с OLED-дисплеем, навигацией по меню и интеллектуальным кешированием.

![Project Status](https://img.shields.io/badge/Status-Working-brightgreen)

---

## � Скачать прошивку

Готовые файлы прошивки для быстрого старта:

- [**pi_pico.uf2**](fw/pi_pico.uf2) - для Raspberry Pi Pico (RP2040)
- [**pi_pico2.uf2**](fw/pi_pico2.uf2) - для Raspberry Pi Pico 2 (RP2350)

**Как прошить:**
1. Зажмите кнопку BOOTSEL на плате
2. Подключите USB кабель к компьютеру
3. Отпустите BOOTSEL - плата появится как USB-накопитель
4. Скопируйте соответствующий `.uf2` файл на этот накопитель
5. Плата автоматически перезагрузится с новой прошивкой

---

## �📋 Содержание

- [Скачать прошивку](#-скачать-прошивку)
- [Возможности](#-возможности)
- [Поддерживаемые платформы](#-поддерживаемые-платформы)
- [Характеристики](#-характеристики)
- [Распиновка](#-распиновка)
- [Структура меню](#-структура-меню)
- [Архитектура](#-архитектура)
- [Сборка проекта](#-сборка-проекта)
- [Использование](#-использование)

---

## ✨ Возможности

### Основные функции
- 🔌 **USB Mass Storage Class** - полная совместимость с Windows/Linux/macOS
- 💿 **Поддержка образов**: 720KB, 1.2MB, 1.44MB
- 📂 **Навигация по каталогам** на SD карте
- 🖥️ **OLED дисплей** для удобного управления
- 🎛️ **Rotary Encoder** для навигации
- ⚡ **Интеллектуальный кеш** с LRU-алгоритмом
- 🔄 **Горячая замена образов** без перезагрузки
- 📊 **Автоопределение формата** диска по размеру файла

### Технические особенности
- **FreeRTOS 11.1.0** с tick rate 10 kHz
- **Многоуровневая архитектура** с 7 задачами
- **320 KB кеш** для Pico 2 или **100 KB** для Pico 1
- **FAT12** файловая система
- **Предзагрузка FAT области** для быстрого доступа
- **Защита от записи** с flush грязных блоков

---

## 🎯 Поддерживаемые платформы

| Платформа | Процессор | RAM | Кеш | Статус |
|-----------|-----------|-----|-----|--------|
| **Raspberry Pi Pico** | RP2040 (Cortex-M0+) | 264 KB | 100 KB | ✅ Поддерживается |
| **Raspberry Pi Pico 2** | RP2350 (Cortex-M33) | 520 KB | 320 KB | ✅ Поддерживается |

> 💡 Проект автоматически определяет платформу при компиляции и настраивает размер кеша

---

## 📊 Характеристики

### Форматы дисков

| Формат | Размер | Секторы | FAT область | Применение |
|--------|--------|---------|-------------|------------|
| **720 KB** | 737 280 bytes | 1 440 | 14 sectors | DD 3.5" |
| **1.2 MB** | 1 228 800 bytes | 2 400 | 19 sectors | HD 5.25" |
| **1.44 MB** | 1 474 560 bytes | 2 880 | 33 sectors | HD 3.5" |

### Производительность

- **Размер сектора**: 512 байт
- **Размер блока кеша**: 4 KB (8 секторов)
- **Скорость I2C**: 400 kHz (Fast Mode)
- **Скорость SPI**: 12.5 MHz
- **Время загрузки FAT**: ~0.5-2 секунды (зависит от формата)

### Система кеширования

#### Pico 2 (RP2350) - 320 KB
```
Total: 320 KB
├─ FAT область: 5 блоков (20 KB постоянно)
└─ Данные: 75 блоков (300 KB с LRU)
```

#### Pico (RP2040) - 100 KB
```
Total: 100 KB
├─ FAT область: 5 блоков (20 KB постоянно)
└─ Данные: 20 блоков (80 KB с LRU)
```

> 💡 **Примечание**: Размер кеша автоматически определяется при компиляции в зависимости от платформы

---

## 🔌 Распиновка

### Схема подключения (GPIO 0-15)

```
┌─────────────────────────────────────────────────────────────────┐
│                    Raspberry Pi Pico / Pico 2                   │
│                                                                 │
│  ┌──────────────────────────────────────────────────────────┐   │
│  │ GPIO0 (TX)  ───────────── UART Debug                     │   │
│  │ GPIO1 (RX)  ───────────── UART Debug                     │   │
│  │                                                          │   │
│  │ GPIO2 (SDA) ───────────── I2C1 → OLED Display            │   │
│  │ GPIO3 (SCL) ───────────── I2C1 → OLED Display            │   │
│  │                                                          │   │
│  │ GPIO4 (MISO)───────────── SPI0 → SD Card (DO)            │   │
│  │ GPIO5 (CS)  ───────────── SPI0 → SD Card (CS)            │   │
│  │ GPIO6 (SCK) ───────────── SPI0 → SD Card (SCK)           │   │
│  │ GPIO7 (MOSI)───────────── SPI0 → SD Card (DI)            │   │
│  │                                                          │   │
│  │ GPIO10      ───────────── Encoder CLK (Phase A)          │   │
│  │ GPIO11      ───────────── Encoder DT (Phase B)           │   │
│  │ GPIO12      ───────────── Encoder SW (Button)            │   │
│  └──────────────────────────────────────────────────────────┘   │
│                                                                 │
│  USB ──────────────────────── USB Mass Storage + CDC Serial     │
└─────────────────────────────────────────────────────────────────┘
```

### Таблица пинов

| Функция | GPIO | Интерфейс | Описание |
|---------|------|-----------|----------|
| **UART TX** | 0 | UART0 | Отладочный вывод |
| **UART RX** | 1 | UART0 | Отладочный ввод |
| **I2C SDA** | 2 | I2C1 | OLED дисплей (данные) |
| **I2C SCL** | 3 | I2C1 | OLED дисплей (такты) |
| **SPI MISO** | 4 | SPI0 | SD карта (RX) |
| **SPI CS** | 5 | SPI0 | SD карта (Chip Select) |
| **SPI SCK** | 6 | SPI0 | SD карта (Clock) |
| **SPI MOSI** | 7 | SPI0 | SD карта (TX) |
| **Encoder A** | 10 | GPIO | Фаза A энкодера |
| **Encoder B** | 11 | GPIO | Фаза B энкодера |
| **Encoder BTN** | 12 | GPIO | Кнопка энкодера |

> ⚠️ **Важно**: Все пины в диапазоне GPIO0-GPIO15 для совместимости с Nano RP2040/RP2350

---

## 🎮 Структура меню

### Главное меню
```
┌─────────────────────┐
│ > Select Image      │
│   SD Card Info      │
└─────────────────────┘
```

### Список образов
```
┌─────────────────────┐
│ > < Back            │  ← Возврат в главное меню
│   [GAMES]           │  ← Каталог
│   [DOS]             │  ← Каталог
│   boot.img          │  ← Файл образа
└─────────────────────┘
```

### Подтверждение загрузки
```
┌─────────────────────┐
│ Load boot.img?      │
│ > Yes               │
│   No                │
└─────────────────────┘
```

### Экран загрузки
```
┌─────────────────────┐
│ Loading FAT...      │
│ 12 / 16 KB          │
└─────────────────────┘
```

### Диск готов
```
┌─────────────────────┐
│ Disk Ready 1.44M    │  ← Размер автоопределен
│ boot.img            │
│ Eject >> Yes  No    │  ← Навигация Up/Down
└─────────────────────┘
```

### Навигация
- **Вращение энкодера**: Перемещение по пунктам меню
- **Короткое нажатие**: Подтверждение (OK)
- **Длинное нажатие**: Возврат назад

---

## 🏗️ Архитектура

### FreeRTOS задачи (7 tasks)

| Задача | Приоритет | Стек | Функция |
|--------|-----------|------|---------|
| **Control Task** | 4 (высший) | 256B | Обработка энкодера и кнопок |
| **USB Task** | 3 | 1024B | TinyUSB MSC callbacks |
| **Menu Task** | 2 | 512B | Логика меню и навигация |
| **OLED Task** | 2 | 512B | Отрисовка на дисплее |
| **SD Card Task** | 2 | 1024B | Работа с FatFS |
| **Floppy Emu Task** | 2 | 1024B | Кеш и эмуляция диска |
| **LED Task** | 1 (низший) | 256B | Индикация состояния |

### Структура кеша

```
┌───────────────────────────────────────────────────────┐
│                    CACHE (320KB / 160KB)              │
├───────────────────────────────────────────────────────┤
│                                                       │
│  ┌──────────────────────────────────────────────┐     │
│  │   FAT CACHE (постоянный)                     │     │
│  │   - Boot sector                              │     │
│  │   - FAT1 + FAT2                              │     │
│  │   - Root directory                           │     │
│  │   ~5 блоков (20 KB)                          │     │
│  └──────────────────────────────────────────────┘     │
│                                                       │
│  ┌──────────────────────────────────────────────┐     │
│  │   DATA CACHE (LRU замещение)                 │     │
│  │   - Файлы и каталоги                         │     │
│  │   - Read-ahead оптимизация                   │     │
│  │   - Отложенная запись (dirty blocks)         │     │
│  │   Pico2: ~75 блоков (300 KB)                 │     │
│  │   Pico1: ~35 блоков (140 KB)                 │     │
│  └──────────────────────────────────────────────┘     │
│                                                       │
└───────────────────────────────────────────────────────┘
```

### Потоки данных

```
┌──────────┐    USB MSC     ┌─────────────┐    Cache    ┌──────────┐
│          │ ◄────────────► │   Floppy    │ ◄─────────► │ SD Card  │
│ Windows  │   READ/WRITE   │  Emulator   │   FatFS     │  (SPI)   │
│  /Linux  │    Sectors     │   + Cache   │   Sectors   │          │
└──────────┘                └─────────────┘             └──────────┘
                                   │
                                   │ Status
                                   ▼
                            ┌─────────────┐
                            │ Menu Task   │
                            └─────────────┘
                                   │
                                   │ Display
                                   ▼
                            ┌─────────────┐
                            │ OLED (I2C)  │
                            └─────────────┘
```

---

## 🛠️ Сборка проекта

### Требования
- **Pico SDK 2.2.0+**
- **CMake 3.13+**
- **ARM GCC Toolchain**
- **VS Code** с расширением Raspberry Pi Pico

### Клонирование репозитория
```bash
git clone <repository-url>
cd UsbFloppyEmu
git submodule update --init --recursive
```

### Компиляция
```bash
mkdir build
cd build
cmake ..
make -j4
```

Или используйте VS Code:
1. Откройте проект в VS Code
2. Нажмите `Ctrl+Shift+P` → "CMake: Configure"
3. Нажмите `Ctrl+Shift+P` → "CMake: Build"

### Прошивка

**Метод 1: BOOTSEL**
1. Удерживая кнопку BOOTSEL, подключите Pico к USB
2. Скопируйте `UsbFloppyEmu.uf2` на диск `RPI-RP2`

**Метод 2: Picotool**
```bash
picotool load UsbFloppyEmu.elf -fx
```

**Метод 3: OpenOCD (с отладчиком)**
```bash
openocd -f interface/cmsis-dap.cfg -f target/rp2350.cfg \
  -c "adapter speed 5000; program UsbFloppyEmu.elf verify reset exit"
```

---

## 📖 Использование

### Подготовка SD карты

1. Отформатируйте SD карту в **FAT32**
2. Создайте структуру каталогов (опционально):
   ```
   /
   ├── GAMES/
   │   ├── doom.img
   │   └── quake.img
   ├── DOS/
   │   ├── msdos622.img
   │   └── win311.img
   └── boot.img
   ```

3. Скопируйте образы дискет (файлы `.img`)

### Форматы образов

Поддерживаемые размеры:
- **720 KB**: 737 280 bytes ±512
- **1.2 MB**: 1 228 800 bytes ±512
- **1.44 MB**: 1 474 560 bytes ±512

Вы можете создать образы с помощью:
- **Windows**: `dd`, WinImage, ImDisk
- **Linux**: `dd if=/dev/fd0 of=floppy.img bs=512`
- **macOS**: `dd if=/dev/rdisk2 of=floppy.img bs=512`

### Работа с устройством

1. **Включение**: Подключите Pico к USB
2. **Выбор образа**: 
   - Вращайте энкодер для навигации
   - Нажмите для входа в каталог или выбора файла
3. **Подтверждение**: Выберите "Yes"
4. **Ожидание**: Загрузка FAT области (~0.5-2 сек)
5. **Готово**: Диск появится в системе
6. **Извлечение**: 
   - Выберите "Eject >> Yes"
   - Или используйте "Безопасное извлечение" в ОС

### Отладка

Подключите UART (115200 8N1):
- **TX**: GPIO 0
- **RX**: GPIO 1

Вывод в консоль:
```
========================================
  USB Floppy Disk Drive Emulator
  FreeRTOS @ 10000 Hz tick rate
  Platform: Raspberry Pi Pico 2 (RP2350)
  Cache: 320 KB
  CPU: 150 MHz
========================================

[SDCARD] Initializing...
[SDCARD] Card detected: SDHC 32768 MB
[FLOPPY] Cache initialized:
[FLOPPY]   Total: 320 KB
[FLOPPY]   FAT blocks: 5 (20 KB)
[FLOPPY]   Data blocks: 75 (300 KB)
[USB] Device mounted
```

---

## 📚 Дополнительная информация

### Конфигурация

Основные настройки в `config.h`:
```c
// Размер кеша (автоматически для Pico/Pico2)
#define CACHE_SIZE_KB  320  // или 160

// I2C для OLED
#define OLED_I2C_PORT  i2c1
#define OLED_I2C_SDA   2
#define OLED_I2C_SCL   3

// SPI для SD карты
#define SD_SPI_PORT    spi0
#define SD_PIN_MISO    4
#define SD_PIN_CS      5
```

### Известные ограничения

- Максимум 32 файла/каталога в одной директории
- Имена файлов обрезаются до 20 символов на дисплее
- Только FAT12/FAT16 на SD карте (FAT32 поддерживается)
- Образы должны быть в формате RAW (не сжатые)

### Производительность

Типичные показатели:
- **Чтение**: ~200-400 KB/s (зависит от SD карты)
- **Запись**: ~150-300 KB/s (с кешем)
- **Cache hit rate**: >90% при обычном использовании
- **Время отклика**: <10 мс для кешированных секторов

---

## 🤝 Вклад в проект

Приветствуются:
- 🐛 Сообщения об ошибках
- 💡 Предложения улучшений
- 🔧 Pull requests
- 📖 Улучшения документации

---

## 📄 Лицензия

Этот проект распространяется под лицензией MIT. См. файл [LICENSE](LICENSE) для подробностей.

---

## 🙏 Благодарности

- **Raspberry Pi Foundation** - за отличную платформу Pico
- **FreeRTOS** - за надежное ядро RTOS
- **TinyUSB** - за USB стек
- **FatFS** - за файловую систему
- **Сообщество разработчиков** - за поддержку и идеи

---

<div align="center">

[⬆ Вернуться к началу](#-usb-floppy-disk-drive-emulator)

</div>

# Floppy Emulator Architecture

## Обзор

Эмулятор флоппи-диска с интеллектуальным кешированием для Raspberry Pi Pico 2.

## Архитектура кеша

### Размеры памяти
- **Общий кеш**: 320 KB
- **FAT область** (постоянная): ~20 KB (5 блоков × 4KB)
- **Кеш данных** (LRU): ~300 KB (75 блоков × 4KB)
- **Блок кеша**: 8 секторов (4 KB)

### Структура кеша

```
┌─────────────────────────────────────────────┐
│         FAT Cache (20 KB)                   │
│  ┌──────────────────────────────────────┐   │
│  │ Block 0: Sectors 0-7   (Boot + FAT1)│   │
│  │ Block 1: Sectors 8-15  (FAT1)        │   │
│  │ Block 2: Sectors 16-23 (FAT2)        │   │
│  │ Block 3: Sectors 24-31 (FAT2 + Root)│   │
│  │ Block 4: Sectors 32-39 (Root Dir)    │   │
│  └──────────────────────────────────────┘   │
├─────────────────────────────────────────────┤
│         Data Cache (300 KB) - LRU           │
│  ┌──────────────────────────────────────┐   │
│  │ Block 0: 8 sectors with timestamp    │   │
│  │ Block 1: 8 sectors with timestamp    │   │
│  │ ...                                   │   │
│  │ Block 74: 8 sectors with timestamp   │   │
│  └──────────────────────────────────────┘   │
└─────────────────────────────────────────────┘
```

## Политика кеширования

### FAT область (секторы 0-32)
- **Политика**: Постоянное хранение
- **Загрузка**: При монтировании образа (предзагрузка)
- **Замещение**: Самый старый блок при необходимости
- **Назначение**: Boot sector, FAT1, FAT2, Root Directory

### Область данных (секторы 33+)
- **Политика**: LRU (Least Recently Used)
- **Загрузка**: По требованию + упреждающее чтение
- **Упреждающее чтение**: 8 секторов при запросе 1
- **Замещение**: Блок с наименьшим timestamp
- **Dirty blocks**: Сброс на SD при замещении или извлечении

## Поток данных

```
┌──────────┐    Read/Write     ┌─────────────┐
│   USB    │ ───────────────> │   Floppy    │
│   MSC    │ <─────────────── │  Emulator   │
└──────────┘                   └─────────────┘
                                     │
                          ┌──────────┴──────────┐
                          │   Cache Manager     │
                          │  - FAT Cache (5)    │
                          │  - Data Cache (75)  │
                          │  - LRU Timestamps   │
                          └──────────┬──────────┘
                                     │
                          ┌──────────┴──────────┐
                          │   SD Card Task      │
                          │  - Read Sector      │
                          │  - Write Sector     │
                          └─────────────────────┘
```

## Процесс загрузки образа

1. **Menu Task** → отправка команды `FLOPPY_CMD_LOAD_IMAGE`
2. **Floppy Emulator**:
   - Очистка кеша
   - Отправка `SDCARD_CMD_LOAD_IMAGE` в SD Card Task
   - Предзагрузка FAT области (33 сектора)
   - Обновление OLED с прогрессом загрузки
   - Установка статуса `FLOPPY_STATUS_READY`

## Процесс чтения

1. **USB MSC** → `floppy_read_sector(sector)`
2. **Cache Lookup**:
   - Определение: FAT область или данные?
   - Поиск блока в соответствующем кеше
3. **Cache Hit**:
   - Обновление timestamp
   - Копирование данных из кеша
   - Увеличение `cache_hits`
4. **Cache Miss**:
   - Поиск свободного/старого блока
   - Сброс dirty блока (если есть)
   - Чтение 8 секторов с SD (упреждающее)
   - Сохранение в кеш с timestamp
   - Увеличение `cache_misses`

## Процесс записи

1. **USB MSC** → `floppy_write_sector(sector)`
2. **Cache Lookup**: аналогично чтению
3. **Cache Miss**: загрузка блока
4. **Write to Cache**:
   - Обновление данных в кеше
   - Установка флага `dirty = true`
   - Обновление timestamp
5. **Write-back**:
   - При замещении dirty блока
   - При извлечении образа (`FLOPPY_CMD_EJECT_IMAGE`)

## Извлечение образа

1. **Menu Task** → `FLOPPY_CMD_EJECT_IMAGE`
2. **Floppy Emulator**:
   - Сброс всех dirty блоков на SD
   - Очистка кеша
   - Отправка `SDCARD_CMD_EJECT` в SD Card Task
   - Установка статуса `FLOPPY_STATUS_NO_IMAGE`

## Статистика и мониторинг

Структура `floppy_info_t`:
- `status` - текущий статус эмулятора
- `current_image` - имя загруженного образа
- `loaded_kb` - загружено KB FAT области
- `cache_hits` - попадания в кеш
- `cache_misses` - промахи кеша

## Потокобезопасность

- **Mutex**: `cache_mutex` защищает все операции с кешем
- **Блокировка**: При чтении/записи через кеш
- **Освобождение**: После завершения операции

## Оптимизации

1. **Предзагрузка FAT**: Все служебные данные в памяти
2. **Упреждающее чтение**: 8 секторов за раз
3. **LRU замещение**: Минимизация SD операций
4. **Отложенная запись**: Dirty blocks записываются только при необходимости
5. **Timestamp 1MHz**: Быстрое сравнение возраста блоков

## Использование памяти

### Статическая память
- FAT Cache: 5 × 4KB = 20 KB
- Data Cache: 75 × 4KB = 300 KB
- Метаданные: ~2 KB
- **Итого**: ~322 KB

### Стек задачи
- Stack Size: 2048 bytes (2 KB)

### Общая память для эмулятора
- **~324 KB** из 520 KB доступных на RP2350

# ĞÑ€Ñ…Ğ¸Ñ‚ĞµĞºÑ‚ÑƒÑ€Ğ° Ğ·Ğ°Ğ´Ğ°Ñ‡ USB Floppy Emulator

## ĞĞ±Ñ‰Ğ°Ñ ÑÑ…ĞµĞ¼Ğ° ÑĞ¸ÑÑ‚ĞµĞ¼Ñ‹

```
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚     Raspberry Pi Pico (RP2040)      â”‚
                    â”‚      FreeRTOS @ 10kHz tick          â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                           HARDWARE LAYER                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚   GPIO      â”‚     I2C      â”‚     SPI     â”‚     USB     â”‚    LED    â”‚
â”‚ (Encoder/   â”‚   (OLED      â”‚  (SD Card   â”‚ (Mass       â”‚  (Status  â”‚
â”‚  Buttons)   â”‚   Display)   â”‚   Reader)   â”‚  Storage)   â”‚   Ind.)   â”‚
â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜
      â”‚              â”‚             â”‚             â”‚             â”‚
      â–¼              â–¼             â–¼             â–¼             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                          TASK LAYER                                  â”‚
â”‚                                                                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚
â”‚  â”‚control_task  â”‚â”€â”€â”€â–ºâ”‚  menu_task   â”‚â”€â”€â”€â–ºâ”‚  oled_task   â”‚         â”‚
â”‚  â”‚ Priority: 4  â”‚    â”‚ Priority: 2  â”‚    â”‚ Priority: 2  â”‚         â”‚
â”‚  â”‚ Stack: 256w  â”‚    â”‚ Stack: 512w  â”‚    â”‚ Stack: 512w  â”‚         â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚
â”‚         â”‚                   â”‚                                       â”‚
â”‚         â”‚              â”Œâ”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”                                â”‚
â”‚         â”‚              â–¼          â–¼                                â”‚
â”‚         â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                   â”‚
â”‚         â”‚    â”‚ sdcard_task  â”‚  â”‚   led_task   â”‚                   â”‚
â”‚         â”‚    â”‚ Priority: 2  â”‚  â”‚ Priority: 1  â”‚                   â”‚
â”‚         â”‚    â”‚ Stack: 1024w â”‚  â”‚ Stack: 256w  â”‚                   â”‚
â”‚         â”‚    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                   â”‚
â”‚         â”‚           â”‚                                              â”‚
â”‚         â”‚           â–¼                                              â”‚
â”‚         â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                     â”‚
â”‚         â””â”€â”€â”€â–ºâ”‚   usb_task   â”‚                                     â”‚
â”‚              â”‚ Priority: 3  â”‚                                     â”‚
â”‚              â”‚ Stack: 1024w â”‚                                     â”‚
â”‚              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                       MESSAGE QUEUES                                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  menu_queue          â”‚  oled_queue       â”‚  sdcard_queue             â”‚
â”‚  (controlâ†’menu)      â”‚  (menuâ†’oled)      â”‚  (menuâ†’sdcard)            â”‚
â”‚                      â”‚                   â”‚                           â”‚
â”‚  usb_queue           â”‚  led_queue        â”‚  sdcard_response_queue    â”‚
â”‚  (controlâ†’usb)       â”‚  (anyâ†’led)        â”‚  (sdcardâ†’menu)            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ĞŸĞ¾Ñ‚Ğ¾Ğº Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ…

### 1. ĞŸĞ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒÑĞºĞ¸Ğ¹ Ğ²Ğ²Ğ¾Ğ´ â†’ Ğ’Ñ‹Ğ±Ğ¾Ñ€ Ğ¾Ğ±Ñ€Ğ°Ğ·Ğ°

```
User Input (Encoder/Buttons)
    â†“
[GPIO Interrupt/Polling @ 1kHz]
    â†“
control_task: Debounce & Decode
    â†“
menu_queue â† control_event_t
    â†“
menu_task: State Machine
    â”œâ”€â–º oled_queue â† Update Menu Display
    â”‚       â†“
    â”‚   oled_task: Draw on SSD1306
    â”‚
    â””â”€â–º sdcard_queue â† Request File List
            â†“
        sdcard_task: Scan .img files via FatFS
            â†“
        sdcard_response_queue â†’ Back to menu_task
```

### 2. Ğ—Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ° Ğ¾Ğ±Ñ€Ğ°Ğ·Ğ° â†’ USB Ğ¿ĞµÑ€ĞµĞ´Ğ°Ñ‡Ğ°

```
menu_task: User confirms image selection
    â†“
sdcard_queue â† SDCARD_CMD_LOAD_IMAGE
    â†“
sdcard_task: Open file, prepare for sector access
    â†“
usb_queue â† USB_CMD_MOUNT
    â†“
usb_task: Enable Mass Storage Device
    â†“
Host Computer reads USB device
    â†“
TinyUSB: tud_msc_read10_cb()
    â†“
sdcard_task: Read sector from .img file
    â†“
Return data to USB host
```

### 3. Ğ˜Ğ½Ğ´Ğ¸ĞºĞ°Ñ†Ğ¸Ñ Ğ°ĞºÑ‚Ğ¸Ğ²Ğ½Ğ¾ÑÑ‚Ğ¸

```
Any Task: Activity occurs
    â†“
led_queue â† led_message_t (LED_MODE_ACTIVITY)
    â†“
led_task: Flash LED for 50ms
```

## Ğ’Ñ€ĞµĞ¼ĞµĞ½Ğ½Ñ‹Ğµ Ñ…Ğ°Ñ€Ğ°ĞºÑ‚ĞµÑ€Ğ¸ÑÑ‚Ğ¸ĞºĞ¸

| Ğ—Ğ°Ğ´Ğ°Ñ‡Ğ°        | ĞŸĞµÑ€Ğ¸Ğ¾Ğ´ Ğ¾Ğ¿Ñ€Ğ¾ÑĞ° | Ğ’Ñ€ĞµĞ¼Ñ Ñ€ĞµĞ°ĞºÑ†Ğ¸Ğ¸ | ĞŸÑ€Ğ¸Ğ¼ĞµĞ½ĞµĞ½Ğ¸Ğµ                    |
|---------------|---------------|---------------|-------------------------------|
| control_task  | 1 ms          | < 2 ms        | Ğ­Ğ½ĞºĞ¾Ğ´ĞµÑ€ Ñ‚Ñ€ĞµĞ±ÑƒĞµÑ‚ Ğ±Ñ‹ÑÑ‚Ñ€Ğ¾Ğ³Ğ¾ Ğ¾Ğ¿Ñ€Ğ¾ÑĞ° |
| usb_task      | 100 Î¼s        | < 500 Î¼s      | USB Ñ‚Ñ€ĞµĞ±ÑƒĞµÑ‚ Ñ‡Ğ°ÑÑ‚Ñ‹Ñ… Ğ²Ñ‹Ğ·Ğ¾Ğ²Ğ¾Ğ² tud_task() |
| menu_task     | ĞŸĞ¾ ÑĞ¾Ğ±Ñ‹Ñ‚Ğ¸Ñ    | < 5 ms        | ĞĞ±Ñ€Ğ°Ğ±Ğ¾Ñ‚ĞºĞ° ÑĞ¾Ğ±Ñ‹Ñ‚Ğ¸Ğ¹ Ğ¸Ğ· Ğ¾Ñ‡ĞµÑ€ĞµĞ´Ğ¸  |
| oled_task     | ĞŸĞ¾ ÑĞ¾Ğ±Ñ‹Ñ‚Ğ¸Ñ    | < 20 ms       | ĞĞ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¸Ğµ Ğ´Ğ¸ÑĞ¿Ğ»ĞµÑ            |
| sdcard_task   | ĞŸĞ¾ ÑĞ¾Ğ±Ñ‹Ñ‚Ğ¸Ñ    | < 100 ms      | Ğ¤Ğ°Ğ¹Ğ»Ğ¾Ğ²Ñ‹Ğµ Ğ¾Ğ¿ĞµÑ€Ğ°Ñ†Ğ¸Ğ¸             |
| led_task      | 10 ms         | 10 ms         | Ğ’Ğ¸Ğ·ÑƒĞ°Ğ»ÑŒĞ½Ğ¾Ğµ Ğ¼Ğ¸Ğ³Ğ°Ğ½Ğ¸Ğµ            |

## ĞšĞ¾Ğ½Ñ„Ğ¸Ğ³ÑƒÑ€Ğ°Ñ†Ğ¸Ñ FreeRTOS

```c
configTICK_RATE_HZ              = 10000     // 10 ĞºĞ“Ñ†
configCPU_CLOCK_HZ              = 133000000 // 133 ĞœĞ“Ñ†
configTOTAL_HEAP_SIZE           = 128KB
configMINIMAL_STACK_SIZE        = 128 words
configMAX_PRIORITIES            = 5
configUSE_PREEMPTION            = 1
configNUM_CORES                 = 2         // RP2040 dual-core
```

## Ğ¡Ğ¸Ğ½Ñ…Ñ€Ğ¾Ğ½Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ Ğ¸ Ğ·Ğ°Ñ‰Ğ¸Ñ‚Ğ° Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ…

- **ĞÑ‡ĞµÑ€ĞµĞ´Ğ¸**: ĞÑĞ½Ğ¾Ğ²Ğ½Ğ¾Ğ¹ Ğ¼ĞµÑ…Ğ°Ğ½Ğ¸Ğ·Ğ¼ Ğ¼ĞµĞ¶Ğ·Ğ°Ğ´Ğ°Ñ‡Ğ½Ğ¾Ğ³Ğ¾ Ğ²Ğ·Ğ°Ğ¸Ğ¼Ğ¾Ğ´ĞµĞ¹ÑÑ‚Ğ²Ğ¸Ñ
- **Mutex**: Ğ”Ğ»Ñ Ğ·Ğ°Ñ‰Ğ¸Ñ‚Ñ‹ ÑĞ¾Ğ²Ğ¼ĞµÑÑ‚Ğ½Ğ¾Ğ³Ğ¾ Ğ´Ğ¾ÑÑ‚ÑƒĞ¿Ğ° Ğº SD ĞºĞ°Ñ€Ñ‚Ğµ
- **Binary Semaphore**: Ğ”Ğ»Ñ ÑĞ¸Ğ³Ğ½Ğ°Ğ»Ğ¸Ğ·Ğ°Ñ†Ğ¸Ğ¸ Ğ·Ğ°Ğ²ĞµÑ€ÑˆĞµĞ½Ğ¸Ñ Ğ¾Ğ¿ĞµÑ€Ğ°Ñ†Ğ¸Ğ¹
- **Event Groups**: Ğ”Ğ»Ñ ĞºĞ¾Ğ¾Ñ€Ğ´Ğ¸Ğ½Ğ°Ñ†Ğ¸Ğ¸ ÑĞ¾ÑÑ‚Ğ¾ÑĞ½Ğ¸Ğ¹ (Ğ¿Ğ»Ğ°Ğ½Ğ¸Ñ€ÑƒĞµÑ‚ÑÑ)

## ĞĞ±Ñ€Ğ°Ğ±Ğ¾Ñ‚ĞºĞ° Ğ¾ÑˆĞ¸Ğ±Ğ¾Ğº

```
Task encounters error
    â†“
Send error message to menu_task
    â†“
menu_task: MENU_STATE_ERROR
    â†“
oled_queue â† Display error message
    â†“
led_queue â† LED_MODE_BLINK_FAST (error indication)
    â†“
Wait for user OK button
    â†“
Return to main menu
```

## Ğ­Ğ½ĞµÑ€Ğ³Ğ¾Ğ¿Ğ¾Ñ‚Ñ€ĞµĞ±Ğ»ĞµĞ½Ğ¸Ğµ

| Ğ ĞµĞ¶Ğ¸Ğ¼         | ĞĞºÑ‚Ğ¸Ğ²Ğ½Ñ‹Ğµ Ğ·Ğ°Ğ´Ğ°Ñ‡Ğ¸                    | ĞŸĞ¾Ñ‚Ñ€ĞµĞ±Ğ»ĞµĞ½Ğ¸Ğµ |
|---------------|------------------------------------|-------------|
| Idle          | led_task (blink)                   | ĞœĞ¸Ğ½Ğ¸Ğ¼ÑƒĞ¼     |
| Menu Browse   | control, menu, oled, led           | ĞĞ¸Ğ·ĞºĞ¾Ğµ      |
| Loading Image | All except USB                     | Ğ¡Ñ€ĞµĞ´Ğ½ĞµĞµ     |
| Active USB    | All tasks                          | ĞœĞ°ĞºÑĞ¸Ğ¼ÑƒĞ¼    |
| Sleep Mode*   | Only critical tasks (Ğ¿Ğ»Ğ°Ğ½Ğ¸Ñ€ÑƒĞµÑ‚ÑÑ) | ĞÑ‡ĞµĞ½ÑŒ Ğ½Ğ¸Ğ·ĞºĞ¾Ğµ|

*ĞŸĞ»Ğ°Ğ½Ğ¸Ñ€ÑƒĞµÑ‚ÑÑ Ñ€ĞµĞ°Ğ»Ğ¸Ğ·Ğ¾Ğ²Ğ°Ñ‚ÑŒ Ñ€ĞµĞ¶Ğ¸Ğ¼ ÑĞ½Ğ° Ñ Ğ¿Ñ€Ğ¾Ğ±ÑƒĞ¶Ğ´ĞµĞ½Ğ¸ĞµĞ¼ Ğ¿Ğ¾ ĞºĞ½Ğ¾Ğ¿ĞºĞµ

## ĞœĞ°ÑÑˆÑ‚Ğ°Ğ±Ğ¸Ñ€ÑƒĞµĞ¼Ğ¾ÑÑ‚ÑŒ

ĞÑ€Ñ…Ğ¸Ñ‚ĞµĞºÑ‚ÑƒÑ€Ğ° Ğ¿Ğ¾Ğ·Ğ²Ğ¾Ğ»ÑĞµÑ‚ Ğ»ĞµĞ³ĞºĞ¾ Ğ´Ğ¾Ğ±Ğ°Ğ²Ğ¸Ñ‚ÑŒ:

- ğŸ“Š **stats_task** - Ğ¼Ğ¾Ğ½Ğ¸Ñ‚Ğ¾Ñ€Ğ¸Ğ½Ğ³ Ğ¿Ñ€Ğ¾Ğ¸Ğ·Ğ²Ğ¾Ğ´Ğ¸Ñ‚ĞµĞ»ÑŒĞ½Ğ¾ÑÑ‚Ğ¸
- ğŸ”Š **audio_task** - Ğ·Ğ²ÑƒĞºĞ¾Ğ²Ñ‹Ğµ ÑÑ„Ñ„ĞµĞºÑ‚Ñ‹ Ñ‡ĞµÑ€ĞµĞ· PWM
- ğŸŒ **network_task** - WiFi Ğ´Ğ»Ñ Ğ·Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ¸ Ğ¾Ğ±Ñ€Ğ°Ğ·Ğ¾Ğ²
- ğŸ’¾ **cache_task** - ĞºÑÑˆĞ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ ÑĞµĞºÑ‚Ğ¾Ñ€Ğ¾Ğ² Ğ´Ğ»Ñ ÑƒÑĞºĞ¾Ñ€ĞµĞ½Ğ¸Ñ
- âš™ï¸ **config_task** - ÑĞ¾Ñ…Ñ€Ğ°Ğ½ĞµĞ½Ğ¸Ğµ Ğ½Ğ°ÑÑ‚Ñ€Ğ¾ĞµĞº Ğ² EEPROM
